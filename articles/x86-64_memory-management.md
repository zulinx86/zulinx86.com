---
title: 【x86-64】メモリ管理（セグメンテーション / ページング）
emoji: "🐧"
type: "tech"
topics: ["x86-64", "paging"]
published: true
---



# 概要

Intel 64 アーキテクチャ もしくは IA-32 アーキテクチャのプロテクトモードにおけるメモリ管理は、(1) セグメンテーション (segmentation) と (2) ページング (paging) の２つの機構で構成される。

メモリ管理は、以下の 3 つの種類のメモリアドレス空間を変換することで行われる。
- 論理アドレス (logical address)
- リニアアドレス (linear address)
- 物理アドレス (physical address)

セグメンテーションは論理アドレスからリニアアドレスの変換を、ページングはリニアアドレスから物理アドレスへの変換を担う。

```
+------------------+
| Logical Address  |
+--------+---------+
         |  Segmentation
         v
+------------------+
|  Linear Address  |
+--------+---------+
         |  Paging
         v
+------------------+
| Physical Address |
+------------------+
```

セグメンテーションは、デフォルトで有効化されており、無効化することはできない。
一方で、ページングは、デフォルトで無効化されており、オプションで有効化することができる。ページングが有効になっていない場合は、リニアアドレスは物理アドレスにそのままマッピングされる。


## セグメンテーション

セグメンテーションとは、リニアアドレス空間 (linear address space) をセグメント (segment) と呼ばれるより小さな保護されたアドレス空間に分離する機構である。

```
 Linear Address Space
    +-----------+
    |           |
    |           |
    +-----------+
    | Segment 1 |
    |           |
    +-----------+
    |           |
    |           |
    |           |
    +-----------+
    | Segment 2 |
    +-----------+
    |           |
    +-----------+
    | Segment 3 |
    |           |
    |           |
    |           |
    +-----------+
    |           |
    +-----------+
```

セグメントには、プログラムのコード、データ、スタックなどを保持することができる。複数のプログラムを単一のプロセッサで実行する場合、それぞれのプログラムにはセグメントの集合が割り当てられる。プログラムは、割り当てられたセグメントの範囲内のデータのみにアクセスすることが許され、他のプログラムのセグメントに干渉しないようにすることができる。

全てのセグメントは、リニアアドレス空間内に含まれており、セグメント内の特定のバイトにアクセスするには、論理アドレス (別名: ファーポインタ (far pointer)) を指定する必要がある。論理アドレスは、以下の２つの要素で構成される。
- セグメントセレクタ (segment selector): セグメントのユニークな指定子
- オフセット (offset): アクセスしようとしているデータのセグメント内での位置

```
   Logical Address
   (or Far Pointer)
          |
    +-----+-----+
    |           |
    v           |
 Segment        v
 Selector     Offset
+-------+ +-------------+
|       | |             |
+-------+ +-------------+
```

セグメントセレクタは、ディスクリプタテーブル (descriptor table) のエントリへのオフセットを提供する。ディスクリプタテーブルは、セグメントに関する情報を保持するセグメントディスクリプタ (segment descriptor) をエントリとして持つ。セグメントディスクリプタには、そのセグメントの開始リニアアドレスが含まれる。

```
   Logical Address
   (or Far Pointer)
          |
    +-----+-----+
    |           |
    v           |
 Segment        v
 Selector     Offset
+-------+ +-------------+
|       | |             |
+---+---+ +-------------+
    |
    | Global Descriptor
    |    Table (GDT)
    |  +-------------+
    |  |             |
    |  |             |
    |  +-------------+
    |  |   Segment   |
    |  |  Descriptor |
    +->+-------------+
       |             |
       |             |
       +-------------+
```

オフセットは、セグメント内のアドレス位置を提供するものであり、セグメントの開始リニアアドレスに加算されることで、リニアアドレスが計算される。

```
(リニアアドレス) = (セグメントの開始リニアアドレス) + (セグメント内のオフセット)
```
```
   Logical Address
   (or Far Pointer)
          |
    +-----+-----+               Linear Address
    |           |                    Space   
    v           |              +--------------+
 Segment        v              |              |
 Selector     Offset           |              |
+-------+ +------------+       |              |
|       | |            +-+     |              |
+---+---+ +------------+ |     |              |
    |                    |     |    Segment   |
    | Global Descriptor  |     +--------------+
    |    Table (GDT)     |     |              |
    |  +-------------+   |     |              |
    |  |             |   |     +--------------+
    |  |             |   |  +->|  Lin. Addr.  |
    |  +-------------+   +->|  +--------------+
    |  |   Segment   |      |  |              |
    |  |  Descriptor +------+->+--------------+
    +->+-------------+         |              |
       |             |         |              |
       |             |         |              |
       +-------------+         |              |
                               |              |
                               |              |
                               +--------------+
```

セグメントに関する情報は、セグメントディスクリプタグローバル・ディスクリプタ・テーブル (Global Descriptor Table (GDT)) と呼ばれるテーブルで管理されており、セグメントセレクタは GDT のオフセットとして使用される。


## ページング

ページングが有効化されていない場合、リニアアドレスがそのまま物理アドレスとして使用される。物理アドレス空間とは、プロセッサがアドレスバスに渡すことができるアドレスの範囲と定義される。

マルチタスクシステムでは、物理メモリに一度に格納することができるサイズよりも大きなリニアアドレス空間を定義することがあり、これを実現するためにリニアアドレス空間を仮想化する方法が必要であり、ページングがまさにこの役割を果たす。

ページングは、仮想的な１つの大きなリニアアドレス空間を、物理メモリとディスクストレージを使って提供する。具体的には、リニアアドレス空間は、ページ (page) と呼ばれる連続する小さなメモリの塊 (一般的には 4 KByte) に分割され、それが物理メモリまたはディスクストレージのいずれかに保存される。OS は、それぞれのページが 物理メモリ または ディスクストレージ上のどの領域に対応するかを保持するデータ構造を管理する。

ページを管理するためのデータ構造は、ページディレクトリ (page directory) やページテーブル (page table) と呼ばれるテーブルで管理される。リニアアドレスのうちの一部はページディレクトリ内のエントリを指定するためのオフセットとして使用され、またリニアアドレスの別の部分はページテーブル内のエントリを指定するためのオフセットとして使用される。残りのビットは、ページ内における位置を指定するためのオフセットとして使用される。

```
 Linear Address                                              Physical Address
      Space                    Linear Address                      Space
+--------------+          +-------+-------+--------+          +-------------+
|              |  +------>|  Dir  | Table | Offset |          |             |
|              |  |       +---+---+---+---+----+---+          |    Page     |
|              |  |           |       |        +-------+      |- - - - - - -|
|              |  |           |       |    Page Table  |      |             |
|              |  |           |       |     +-------+  |      +-------------+
|    Segment   |  |  +--------+       |     |       |  |   +->| Phys. Addr. |
+--------------+  |  |                |     |       |  |   |  +-------------+
|              |  |  | Page Directory |     +-------+  +-->|  |             |
|              |  |  |   +-------+    |     | Entry +------+->|- - - - - - -|
+--------------+  |  |   |       |    |  +->+-------+         |             |
|  Lin. Addr.  +--+  |   +-------+    +->|  |       |         |             |
+--------------+     +-->| Entry +-------+->+-------+         |             |
|              |         +-------+                            |             |
+--------------+         |       |                            |             |
|              |         |       |                            |             |
|              |         +-------+                            |             |
|              |                                              |             |
|              |                                              |             |
|              |                                              |             |
|              |                                              |             |
+--------------+                                              +-------------+
```

アクセスしているページが、物理メモリ内に存在しておらず、ディスクストレージに退避されていた場合、プロセッサはプログラムの実行を中断し、ディスクストレージから対応するデータを物理メモリ上に読み出し、その後にプログラムの実行を再開する。そのプログラムを中断するための例外を、ページフォルト (page fault) とよぶ。

なお、ページングはページ単位でさまざまな保護を設定可能であり、セグメントが提供する保護の代わりに使用されることもある。


## 全体像

以上のことをまとめると、以下のようになる。

```
   Logical Address
   (or Far Pointer)
          |
    +-----+-----+               Linear Address                                              Physical Address
    |           |                    Space                    Linear Address                      Space
    v           |              +--------------+          +-------+-------+--------+          +-------------+
 Segment        v              |              |  +------>|  Dir  | Table | Offset |          |             |
 Selector     Offset           |              |  |       +---+---+---+---+----+---+          |    Page     |
+-------+ +------------+       |              |  |           |       |        +-------+      |- - - - - - -|
|       | |            +-+     |              |  |           |       |    Page Table  |      |             |
+---+---+ +------------+ |     |              |  |           |       |     +-------+  |      +-------------+
    |                    |     |    Segment   |  |  +--------+       |     |       |  |   +->| Phys. Addr. |
    | Global Descriptor  |     +--------------+  |  |                |     |       |  |   |  +-------------+
    |    Table (GDT)     |     |              |  |  | Page Directory |     +-------+  +-->|  |             |
    |  +-------------+   |     |              |  |  |   +-------+    |     | Entry +------+->|- - - - - - -|
    |  |             |   |     +--------------+  |  |   |       |    |  +->+-------+         |             |
    |  |             |   |  +->|  Lin. Addr.  |--+  |   +-------+    +->|  |       |         |             |
    |  +-------------+   +->|  +--------------+     +-->| Entry +-------+->+-------+         |             |
    |  |   Segment   |      |  |              |         +-------+                            |             |
    |  |  Descriptor +------+->+--------------+         |       |                            |             |
    +->+-------------+         |              |         |       |                            |             |
       |             |         |              |         +-------+                            |             |
       |             |         |              |                                              |             |
       +-------------+         |              |                                              |             |
                               |              |                                              |             |
                               |              |                                              |             |
                               +--------------+                                              +-------------+

|---------------------------------------|-------------------------------------------------------------------|
              Segmentation                                            Paging
```

以降の章では、さらに詳しく見ていく。



# セグメンテーション


## IA-32e モードにおけるセグメンテーション

Intel 64 アーキテクチャの IA-32e モードでは、セグメンテーションの効果は、現在の動作モードが互換モード (compatibility mode) か 64-bit モードであるかによって決まる。

互換モードで動作している場合、(IA-32 アーキテクチャの) プロテクトモードと同じように、セグメンテーションは機能する。

64-bit モードで動作している場合、セグメンテーションは一般的には (完全にではないが) 無効化されており、セグメントに分割されていないフラットな 64-bit のリニアアドレス空間を形成する。プロセッサは、セグメントレジスタ CS, DS, ES, SS のセグメントのベースアドレスを 0 として扱う。一部のセグメントレジスタ FS および GS は例外であり、ローカルデータや OS のデータ構造にアクセスするためのリニアアドレス計算で、ベースアドレスを提供するものとして利用できる。(セグメントレジスタに関しては後述)

なお、64-bit モードでは、実行時のセグメントの範囲チェックは行われない。


## 論理アドレス

論理アドレス (別名: ファーポインタ) は、16-bit のセグメントセレクタと 32-bit のオフセットで構成される。

### セグメントセレクタ

16-bit のセグメントセレクタは、以下のようなデータ構造である。
- Bits 0-1: Requested Privilege Level (RPL)
    - セレクタの特権レベル (今回は詳細は割愛)。
- Bit 2: Table Indicator (TI) フラグ
    - 使用するディスクリプタテーブルを指定する。
    - 0 のときは GDT (Global Descriptor Table)、1 のとき LDT (Local Descriptor Table) が使用される
- Bits 3-15: インデックス
    - GDT または LDT 内にある 8192 個のディスクリプタの１つを指定する。
    - プロセッサは、インデックスの値に 8 をかけて、それを GDT または LDT のベースアドレスに加算することで、ディスクリプタのアドレスを計算する。
    - 8 = 2^3 なので、インデックスの値に 8 をかける操作は、実際にはセグメントセレクタの下位 3 bit をマスクすることで計算できる。

```
 15                        3  2  1  0
+---------------------------+--+-----+
|           Index           |TI| RPL |
+---------------------------+--+-----+
```

### セグメントレジスタ

プロセッサは最大 6 個のセグメントレジスタ (CS, SS, DS, ES, FS, GS) を提供している。各セグメントレジスタは、コード、スタック、データのいずれかのメモリ参照をサポートする。プログラムが実行される際には、コードセグメント (CS)、データセグメント (DS)、スタックセグメント (SS) に、有効なセグメントセレクタを読み込む必要がある。他の 3 つのセグメントレジスタ (ES, FS, GS) は、追加のデータセグメントとして使用できる。

各セグメントレジスタは、見える部分と隠された部分 (ディスクリプタキャッシュ (descriptor cache) または シャドーレジスタ (shadow register) とも呼ばれる) がある。見える部分には、セグメントセレクタが読み込まれる。隠された部分には、セグメントセレクタが指しているセグメントディスクリプタから、ベースアドレス、セグメントリミット、アクセス制御情報がキャッシュされる。よって、セグメントディスクプリタが更新された場合には、キャッシュを更新するために、セグメントレジスタをリロードする必要がある。

### セグメントディスクリプタ

セグメントディスクリプタは、GDT や LDT 内のエントリとして保存されるデータ構造で、セグメントのサイズや場所、アクセス制御情報などが含まれる。セグメントディスクリプタは、通常コンパイラ、リンカ、ローダー、OS などによって生成される。

- セグメントリミット (Segment Limit)
    - セグメントのサイズを指定する 20-bit の値。
    - G フラグの値で解釈が変わる。
        - 0 のとき、1 byte 単位 (範囲: 1 byte ~ 1 MByte)。
        - 1 のとき、4 KByte 単位 (範囲: 4 KByte)。
    - 上方向に伸びる (expand-up) データセグメントの場合、オフセットは 0 ~ セグメントリミットの間の値をとる。
    - 下方向に伸びる (expand-down) データセグメントの場合、オフセットはセグメントリミット + 1 ~ 0xFFFF_FFFF or 0xFFFF (D/B フラグに依存) の間の値をとる。セグメントリミットの値を減らすことによって、スタック領域を広げることができる。
- ベースアドレス (Segment base address)
    - 4 GByte リニアアドレス空間におけるセグメントの開始位置。
    - 16 byte 境界に整列されていることが好ましい。
- タイプ (Type)
    - セグメントまたはゲートのタイプ、アクセスの種類、セグメントが伸びる方向を指す。
- S フラグ (Descriptor type)
    - 0 のとき、システムセグメント (今回は詳細は割愛) 。
    - 1 のとき、コードセグメントまたはデータセグメント。
- DPL (Descriptor Privilege Level)
    - セグメントの特権レベル (今回は詳細は割愛)。
- P フラグ (Segment present)
    - 0 のとき、セグメントがメモリにない。セグメントレジスタに読み込まれると、Segment Not Present 例外 (#NP) が生成される。
    - 1 のとき、セグメントがメモリにない。
- D/B フラグ (Default operation size / default stack pointer size / upper bound)
    - セグメントが、コードセグメントか、下に伸びるデータセグメントか、スタックセグメントかで解釈が変わる。
    - コードセグメント
        - 0 のとき、16-bit アドレス、16-bit or 8-bit オペランド
        - 1 のとき、32-bit アドレス、32-bit or 8-bit オペランド
        - 命令プレフィックスとして 66H をつけると、デフォルトとは異なるオペランドサイズを使用できる。
        - 命令プレフィックスとして 67H をつけると、デフォルトとは異なるアドレスサイズを使用できる。
    - スタックセグメント (SS レジスタで指定されるデータセグメント)
        - 0 のとき、16-bit のスタックポインタ (SP レジスタに保持される)
        - 1 のとき、32-bit のスタックポインタ (ESP レジスタに保持される)
        - 下方向に伸びるように設定されている場合、スタックセグメントの上限値も指定する。
    - 下に伸びるデータセグメント
        - 0 のとき、上限は 64 KByte (0xFFFF)
        - 1 のとき、上限は 4 GByte (0xFFFF_FFFF)
- G フラグ (Granularity)
    - 0 のとき、セグメントリミットは 1 byte 単位。
    - 1 のとき、セグメントリミットは 4 KByte 単位。
- L フラグ (64-bit code segment)
    - IA-32e モードにおいて、コードセグメントが 64-bit モードがどうかを示す。
    - 0 のとき、互換モードで実行される。
    - 1 のとき、64-bit モードで実行される。
- AVL ビット (Available for use by system software)
    - システムソフトウェア (OS) が自由に利用できるビット。

```
 63  　　　　　　　　　　　　　　 56  55  54  53  52  51            48  47  46  45  44  43          40  39                          32
+-------------------------------+---+---+---+---+-----------------+---+-------+---+---------------+-------------------------------+
|       Base Address 31:24      | G |D/B| L |AVL| Seg. Lim. 19:16 | P |  DPL  | S |      Type     |       Base Address 23:16      |
+-------------------------------+---+---+---+---+-----------------+---+-------+---+---------------+-------------------------------+

 31                                                            16  15                                                          00
+-----------------------------------------------------------------+---------------------------------------------------------------+
|                       Base Address 15:00                        |                        Segment Limit 15:00                    |
+-----------------------------------------------------------------+---------------------------------------------------------------+
```

### コードセグメント / データセグメントのディスクリプタタイプ

セグメントディスクリプタの S フラグが 1 の場合、コードセグメントまたはデータセグメントのいずれかである。

| Decimal | Bit 43 | Bit 42 | Bit 41 | Bit 40 | Descriptor Type | Description                        |
|---------|--------|--------|--------|--------|-----------------|------------------------------------|
|         |        | **E**  | **W**  | **A**  |                 |                                    |
| 0       | 0      | 0      | 0      | 0      | Data            | Read-Only                          |
| 1       | 0      | 0      | 0      | 1      | Data            | Read-Only, accessed                |
| 2       | 0      | 0      | 1      | 0      | Data            | Read/Write                         |
| 3       | 0      | 0      | 1      | 1      | Data            | Read/Write, accessed               |
| 4       | 0      | 1      | 0      | 0      | Data            | Read-Only, expand-down             |
| 5       | 0      | 1      | 0      | 1      | Data            | Read-Only, expand-down, accessed   |
| 6       | 0      | 1      | 1      | 0      | Data            | Read/Write, expand-down            |
| 7       | 0      | 1      | 1      | 1      | Data            | Read/Write, expand-down, accessed  |
|         |        | **C**  | **R**  | **A**  |                 |                                    |
| 8       | 1      | 0      | 0      | 0      | Code            | Execute-Only                       |
| 9       | 1      | 0      | 0      | 0      | Code            | Execute-Only, accessed             |
| 10      | 1      | 0      | 0      | 0      | Code            | Execute/Read                       |
| 11      | 1      | 0      | 0      | 0      | Code            | Execute/Read, accessed             |
| 12      | 1      | 0      | 0      | 0      | Code            | Execute-Only, conforming           |
| 13      | 1      | 0      | 0      | 0      | Code            | Execute-Only, conforming, accessed |
| 14      | 1      | 0      | 0      | 0      | Code            | Execute/Read, conforming           |
| 15      | 1      | 0      | 0      | 0      | Code            | Execute/Read, conforming, accessed |

- データセグメント
    - A (accessed): OS が最後にこのビットをクリアしてから、セグメントがアクセスされたかどうか。
    - W (write-enable): 書き込み可能かどうか。
    - E (expansion-direction): 下方向に伸びるか、上方向に伸びるか。
- コードセグメント
    - A (accessed): OS が最後にこのビットをクリアしてから、セグメントがアクセスされたかどうか。
    - R (read-enable): 読み取り可能かどうか。
    - C (conforming): より高い特権のコンフォーミングセグメントへの実行の転移は、現在の特権レベル (CPL) のまま実行を続けることができる。CPL と異なる特権レベルのノンコンフォーミングセグメントへの実行の転移は、コールゲート (call gate) やタスクゲート (task gate) でない限り、一般保護例外 (general-protection exception (#GP)) が生成される。



# ページング


## ページングモード

ソフトウェアは、ページングを有効にするために、アドレス変換で使用されるデータ構造を初期化し、アドレス変換処理の最初に使用されるデータ構造の物理アドレスを CR3 レジスタに含めておく必要がある。

ソフトウェアは、MOV 命令で CR0.PG をセットすることで、ページングを有効にできる。ただし、CR0.PE = 1 が有効な場合に限る。

ページングが有効化されると、CR4.PAE、CR4.LA57、IA32_EFER.LME の値に基づいて、4 つのページングモードのいずれかが使用される。
- 32-bit ページング (CR4.PAE = 0)
- PAE (Physical Address Extension) ページング (CR4.PAE = 1 かつ IA32_EFER.LME = 0)
- 4 レベルページング (CR4.PAE = 1 かつ IA32_EFER.LME = 1 かつ CR4.LA57 = 0)
- 5 レベルページング (CR4.PAE = 1 かつ IA32_EFER.LME = 1 かつ CR4.LA57 = 1)

ページングモードは、それぞれ以下のような点で異なる。
- リニアアドレスの大きさ
- 物理アドレスの大きさ
- ページの大きさ
- 実行保護機能 (execute-disable access right) のサポート
- PCID のサポート
- プロテクションキー (protection keys) のサポート

| Paging Modfe | CR0.PG | CR4.PAE | IA32_EFER.LME | CR4.LA57 | Lin. Addr. Width | Phys. Addr. Width | Page Size          | Execute Disable | PCIDs / Protection keys |
|--------------|--------|---------|---------------|----------|------------------|-------------------|--------------------|-----------------|-------------------------|
| None         | 0      | N/A     | N/A           | N/A      | 32               | 32                | N/A                | No              | No                      |
| 32-bit       | 1      | 0       | 0             | N/A      | 32               | Up to 40          | 4 KB / 4 MB        | No              | No                      |
| PAE          | 1      | 1       | 0             | N/A      | 32               | Up to 52          | 4 KB / 2 MB        | Yes             | No                      |
| 4-level      | 1      | 1       | 1             | 0        | 48               | Up to 52          | 4 KB / 2 MB / 1 GB | Yes             | Yes                     |
| 5-level      | 1      | 1       | 1             | 1        | 57               | Up to 52          | 4 KB / 2 MB / 1 GB | Yes             | Yes                     |

32-bit ページングと PAE ページングはレガシーなプロテクトモードで使用され、レガシーなプロテクトモードは 32-bit より大きなリニアアドレスを生成できないので、これらは 32-bit リニアアドレスを変換する。

4 レベルページングと 5 レベルページングは IA-32e モードでのみ使用される。
- 互換モード: 32-bit リニアアドレスを使用し、Bits 63:32 は 0 として解釈される。
- 64-bit モード: プロセッサは標準化を強制する。4 レベルページングでは Bits 63:47 が同一 (全て 0 または 全て 1) であり、5 レベルページングでは Bits 63:56 が同一 (全て 0 または 全て 1) である。


## 階層的なページング構造

いずれのページングモードでも、階層的なページング構造 (hierarchical paging structure) を使って、アドレス変換を行う。

各ページング構造は 4096 byte のサイズを持ち、複数のエントリから構成される。32-bit ページングでは、エントリの大きさは 32 bits (4 bytes) で、合計 1024 個のエントリで構成される。それ以外のページングモードでは、エントリの大きさは 64 bits (8 bytes) で、合計 512 個のエントリで構成される。

プロセッサは、リニアアドレスの上位ビットを利用して、ページング構造内のエントリを特定する。最後のレベルのエントリでは、物理アドレス空間上のメモリ領域が特定され、これはページフレーム (page frame) と呼ばれる。リニアアドレスの下位ビットは、ページオフセット (page offset) と呼ばれ、ページ内での参照したいデータの位置を指す。

各ページング構造は、物理アドレスを含んでおり、これは別のページング構造のアドレスまたはページフレームのアドレスを指す。

ページングは、CR3 レジスタに保存された物理アドレスに配置されたページング構造から変換処理が始まる。リニアアドレスは、反復的な処理を通して変換されていく。リニアアドレスの上位アドレスビットをインデックスとして使用して、ページング構造内のエントリを特定する。そのエントリが別のページング構造を指している場合は、同様にリニアアドレスの次に上位のアドレスビットをインデックスとして使用して、次のページング構造内のエントリを特定する。エントリが実際のページを指している場合は、オフセットを追加して、物理アドレスを得ることができる。

ページサイズが 4 KByte の場合、それぞれのページングモードで以下のようにリニアアドレスは利用される。
- 32-bit ページング
    - 各ページング構造は、1024 (= 2^10) 個のエントリで構成され、32-bit リニアアドレスの 10 bits をアドレス変換に用いる。
    - 最初のページング構造で Bits 31:22 を使い、次のページング構造で Bits 21:12 を使用する。残りの Bits 11:0 はページ内オフセットを提供する。
- PAE ページング
    - 最初のページング構造では、4 (=2^2) 個のエントリで構成され、Bits 31:30 が使用される。
    - 残りのページング構造では、9 bits ずつ Bits 29:21、Bits 20:12 が使用され、残りの Bits 11:0 がページ内オフセットとなる。
- 4 レベルページング
    - 各ページング構造は 512 (=2^9) 個のエントリで構成され、48-bit リニアアドレスの上から Bits 47:39、Bits 38:30、Bits 29:21、Bits 20:12 が順に利用され、残りの Bits 11:0 はページ内オフセットとして利用される。
- 5 レベルページング
    - 4 レベルページングとほぼ同様の動作をし、48-bit リニアアドレスに 9 bits 増えた 57-bit リニアアドレスが利用される。

ページング構造を階層的に辿っていくことをページウォーク (page walk) または ページテーブルウォーク (page table walk) と呼ぶ。

最終的なページフレームを特定するまでの間で、このページテーブルウォークが中断される場合があり、これをページフォルト (page fault) と呼ぶ。ページフォルトは、辿られたページング構造のエントリで "not present" ビット (P フラグ) が 0 の場合 または 予約ビット (reserved bit) がセットされている場合に発生し、ページフォルト例外が生成される。

ページング構造のエントリが、別のページング構造を指しているかどうかは、以下のように判定される (ページサイズが 4 KByte の場合)。
- まだ使用されていないリニアアドレスが 12 bits よりも多く残っており、現在のページング構造エントリで PS フラグ (bit 7) が 0 であれば、別のページング構造を指していることになる。PS フラグが 1 である場合は、そのエントリはページフレームへマッピングされていることを意味する。
- 使用されていないリニアアドレスが 12 bits である場合は、現在のページング構造エントリは常にページフレームへマップされている。

ページング構造は、以下のような名前がつけれらている。

| Paging Structure             | Entry Name |
|------------------------------|------------|
| PML5 table                   | PML5E      |
| PML4 table                   | PML4E      |
| Page-directory-pointer table | PDPTE      |
| Page directory               | PDE        |
| Page table                   | PTE        |


## ページング構造の詳細

以下の表は、異なるページングモードで共通するフィールドを、ざっくりまとめたものである。
後述の各ページングモードのページング構造を見ながら、適宜戻って見ることをおすすめします。

| Bit | Description |
|-----|-------------|
| P   | Present; ページが現時点で物理メモリに存在するかどうか。例えば、ページがディスクストレージに退避されている場合に 0 にする。 |
| R/W | Read/Write; 1 の場合、読み書き可能。0 の場合、読み取りのみ。 |
| U/S | User/Supervisor; 1 の場合、どの特権レベルからでもアクセス可。0 の場合、スーパーバイザのみがアクセス可。 |
| PWT | Page-level Write-Through; 1 の場合、write-through caching が有効。0 の場合、write-back caching が有効。 |
| PCD | Page-level Cache Disable; 1 の場合、ページはキャッシュされない。0 の場合、キャッシュされる。 |
| A   | Accessed; アドレス変換の過程でエントリがアクセスされたかどうか。 |
| D   | Dirty; ページに対して書き込みが行われたかどうか。 |
| PS  | Page Size; 1 の場合、そのエントリがページフレームを指している。0 の場合、別のページング構造を指している。 |
| G   | Global; CR3 に MOV 命令を実行した場合に TLB エントリを無効化しない。グローバルページを有効にするために CR4.PGE = 1 にしている必要がある。 |
| PAT | Page Attribute Table; PAT がサポートされている場合に、PWT / PCD と組み合わせてメモリキャッシュの挙動が決まる。 |
| XD  | Execute-disable; EFER.NXE = 1 のとき、このページ内のアドレスにある命令を実行することができない。 |

### 32-bit ページング

```
 31  30  29  28  27  26  25  24  23  22  21  20  19  18  17  16  15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                           Address of page directory                           |           Ignored         |PCD|PWT|  Ignored  | CR3
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|Bits 31:22 of address of 4MB page frame|      Reserved     |  Bits 39:22   |PAT|  Ignored  | G | 1 | D | A |PCD|PWT|U/S|R/W| 1 | PDE: 4MB page
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                             Address of page table                             |    Ignored    | 0 |Ign| A |PCD|PWT|U/S|R/W| 1 | PDE: page table
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                                                          Ignroed                                                          | 0 | PDE: not present
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                           Address of 4KB page frame                           |  Ignored  | G |PAT| D | A |PCD|PWT|U/S|R/W| 1 | PTE: 4KB page
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                                                          Ignored                                                          | 0 | PTE: not present
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
```

### PAE ページング

```
 63  62  61  60  59  58  57  56  55  54  53  52  51  ..  M   M-1 ..  31  30  29  28  27  26  25  24  23  22  21  20  19  18  17  16  15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                            Ignored                                |                            Address of page-directory pointer table                                        |      Ignored      | CR3
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                         Reserved                          |                        Address of page directory                                      |  Ignored  |   Reserved    |PCD|PWT| Rsrvd | 1 | PDPTE: present
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                                                                                      Ignored                                                                                                  | 0 | PDPTE: not present
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|XD |                       Reserved                        |             Address of 2MB page frame             |          Reserved             |PAT|  Ignored  | G | 1 | D | A |PCD|PWT|U/S|R/W| 1 | PDE: 2MB page
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|XD |                       Reserved                        |                                  Address of page table                                |    Ignored    | 0 |Ign| A |PCD|PWT|U/S|R/W| 1 | PDE: page table
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                                                                                      Ignored                                                                                                  | 0 | PDE: not present
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|XD |                       Reserved                        |                                Address of 4KB page frame                              |  Ignored  | G |PAT| D | A |PCD|PWT|U/S|R/W| 1 | PTE: 4KB page
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                                                                                      Ignored                                                                                                  | 0 | PTE: not present
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
```

### 4 レベルページング / 5 レベルページング

```
 63  62  61  60  59  58  57  56  55  54  53  52  51  ..  M   M-1 ..  31  30  29  28  27  26  25  24  23  22  21  20  19  18  17  16  15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                          Reserved                         |                            Address of PML4 table or PML5 table                        |          Ignored          |PCD|PWT|  Ignored  | CR3
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|XD |                 Ignored                   | Reserved  |                                    Address of PML4 table                              | R |  Ignored  |Rsv|Ign| A |PCD|PWT|U/S|R/W| 1 | PML5E: present
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                                                                                      Ignored                                                                                                  | 0 | PML5E: not present
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|XD |                 Ignored                   | Reserved  |                          Address of page-directory-pointer table                      | R |  Ignored  |Rsv|Ign| A |PCD|PWT|U/S|R/W| 1 | PML4E: present
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                                                                                      Ignored                                                                                                  | 0 | PML4E: not present
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|XD |Protection Key |         Ignored           | Reserved  |Addr. of 1GB PF|                              Reseverd                             |PAT| R |Ignored| G | 1 | D | A |PCD|PWT|U/S|R/W| 1 | PDPTE: 1GB page
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|XD |                 Ignored                   | Reserevd  |                                  Address of page directory                            | R |  Ignored  | 0 |Ign| A |PCD|PWT|U/S|R/W| 1 | PDPTE: page directory
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                                                                                      Ignored                                                                                                  | 0 | PDPTE: not present
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|XD |Protection Key |         Ignored           | Reserved  |            Address of 2MB page frame              |           Reserved            |PAT| R |Ignored| G | 1 | D | A |PCD|PWT|U/S|R/W| 1 | PDE: 2MB page
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|XD |                 Ignored                   | Reserved  |                                    Address of page table                              | R |  Ignored  | 0 |Ign| A |PCD|PWT|U/S|R/W| 1 | PDE: page table
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                                                                                      Ignored                                                                                                  | 0 | PDE: not present
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|XD |Protection Key |         Ignored           | Reserved  |                                  Address of 4KB page frame                            | R |Ignored| G |PAT| D | A |PCD|PWT|U/S|R/W| 1 | PTE: 4KB page
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                                                                                      Ignored                                                                                                  | 0 | PTE: not present
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
```


## アクセス権限


# まとめ

