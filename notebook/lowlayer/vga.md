---
layout: post
title: VGA (Video Graphics Array)
---


## Memory Mapped I/O (MMIO)
- The VGA hardware contains a 256 KiB video memory.
- The video memory consists of four planes, each with 64 KiB size, giving the 256 KiB video memory.
- The CPU can access the video memory through a window of up to 128 KiB located in 0x000a0000 - 0x000bffff.
- In order to be able to access the video memory, you must deal with registers that control the mapping into CPU address space.


### 16 Color Graphics
- 16 colors means that there are 4 bits used per color.
- The VGA has four planes and each plane holds one bit of each pixel.
- Since the information for each pixel is scattered over four memory locations.

| Intensity | Red | Green | Blue | Color             |
| --------- | --- | ----- | ---- | ----------------- |
| 0         | 0   | 0     | 0    | Black             |
| 0         | 0   | 0     | 1    | Blue              |
| 0         | 0   | 1     | 0    | Green             |
| 0         | 0   | 1     | 1    | Cyan              |
| 0         | 1   | 0     | 0    | Red               |
| 0         | 1   | 0     | 1    | Magenta           |
| 0         | 1   | 1     | 0    | Brown             |
| 0         | 1   | 1     | 1    | White             |
| 1         | 0   | 0     | 0    | Dark Gray         |
| 1         | 0   | 0     | 1    | Light Blue        |
| 1         | 0   | 1     | 0    | Light Green       |
| 1         | 0   | 1     | 1    | Light Cyan        |
| 1         | 1   | 0     | 0    | Light Red         |
| 1         | 1   | 0     | 1    | Light Magenta     |
| 1         | 1   | 1     | 0    | Yellow            |
| 1         | 1   | 1     | 1    | Intensified White |


### 256 Color Graphics
- Each byte of video memory describes exactly one pixel.
- Pixels are generated by increasing address in linear mode, with all colors taken from plane 0.



## Port I/O
### Port 0x03c7, 0x03c8 and 0x03c9
- Port 0x03c7, 0x03c8 and 0x03c9 control the DAC.
	- Port 0x03c7: DAC Address Read Mode Register
	- Port 0x03c8: DAC Address Write Mode Register
	- Port 0x03c9: DAC Data Register
- Each register in the DAC consists of 18 bits, 6 bits for each color component.
- How to write the DAC entries
	- Write the color index to port 0x03c8, then write 3 bytes to 0x03c9 in the order red, green, blue.
	- If you want to write multiple consecutive DAC entries, you only need to write the first entry's index to 0x03c8 then write all values to 0x03c9 in order red, green, blue, red, gree, blue, and so on. The accessed DAC entry will automatically increment after every three bytes written.
- How to read the DAC entries
	- Write the index to be read to 0x03c7, then read the bytes from port 0x03c9 in a similar fashion.

```c
#define PORT_VIDEO_WRITE 0x03c8
#define PORT_VIDEO_DATA  0x03c9

void init_palette(void)
{
	static unsigned char table_rgb[16 * 3] = {
		0x00, 0x00, 0x00,	/*  0: bloack */
		0xff, 0x00, 0x00,	/*  1: bright red */
		0x00, 0xff, 0x00,	/*  2: bright green */
		0xff, 0xff, 0x00,	/*  3: bright yellow */
		0x00, 0x00, 0xff,	/*  4: bright blue */
		0xff, 0x00, 0xff,	/*  5: bright purple */
		0x00, 0xff, 0xff,	/*  6: bright light blue */
		0xff, 0xff, 0xff,	/*  7: white */
		0xc6, 0xc6, 0xc6,	/*  8: bright gray */
		0x84, 0x00, 0x00,	/*  9: dark red */
		0x00, 0x84, 0x00,	/* 10: dark green */
		0x84, 0x84, 0x00,	/* 11: dark yellow */
		0x00, 0x00, 0x84,	/* 12: dark blue */
		0x84, 0x00, 0x84,	/* 13: dark purple */
		0x00, 0x84, 0x84,	/* 14: dark light blue */
		0x84, 0x84, 0x84	/* 15: dark gray */
	};

	set_palette(0, 16, table_rgb);
}

void set_palette(int start, int end, unsigned char *rgb)
{
	int i, eflags;

	eflags = io_load_eflags();	/* get eflags */
	io_cli();					/* disable interrupt */

	io_out8(PORT_VIDEO_WRITE, start);
	for (i = start; i < 3 * end; ++i)
		io_out8(PORT_VIDEO_DATA, rgb[i] / 4);

	io_store_eflags(eflags);	/* set eflags */
}
```


### Port 0x03C4 and 0x03C5
- Port 0x03C4 and 0x03C5 control the sequencer.
	- Port 0x03C4: Address register
	- Port 0x03C5: Data register


### Port 0x03CE and 0x03CF
- Port 0x03CE and 0x03CF control graphics controller.
	- Port 0x03CE: Address register
	- Port 0x03CF: Data register



## VESA BIOS Extensions (VBE)
- The traditional `int 0x10` BIOS calls are limited to resolutions of 640x480 pixels with 16 color (4-bit) depth / 320x200 pixels with 256 color (8-bit) depth or less.
- VBE is a VESA standard that defines the interface that can be used by software to access compliant video boards at high resolutions and bit depths.


### VBE Modes

<table>
	<tr>
		<th>Mode</th>
		<th>Resolution</th>
		<th>Bits Per Pixel</th>
	</tr>
	<tr>
		<td>0x0100</td>
		<td>640x400</td>
		<td>8</td>
	</tr>
	<tr>
		<td>0x0101</td>
		<td>640x480</td>
		<td>8</td>
	</tr>
	<tr>
		<td>0x0103</td>
		<td>800x600</td>
		<td>8</td>
	</tr>
	<tr>
		<td>0x0105</td>
		<td>1024x768</td>
		<td>8</td>
	</tr>
	<tr>
		<td>0x0107</td>
		<td>1280x1024</td>
		<td>8</td>
	</tr>
</table>


### VBE Functions
#### AX = 0x4F00 - Retrun VBE Controller Information
- Parameters
	- ES:DI = Pointer to VbeInfoBlock
- Return values
	- AX = VBE return status (0x004f = success)

VbeInfoBlock

| Offset | Description            |
| ------ | ---------------------- |
| 0x00   | VBE signature ("VESA") |
| 0x04   | VBE version            |

#### AX = 0x4F01 - Return VBE Mode Information
- Paramaters
	- CX = Mode number
	- ES:DI = Pointer to ModeInfoBlock
- Return values
	- AX = VBE return status (0x004f = success)

ModeInfoBlock

| Offset | Description                                   |
| ------ | --------------------------------------------- |
| 0x00   | Mode attributes                               |
| 0x12   | Horizontal resolution                         |
| 0x14   | Vertical resolution                           |
| 0x19   | Bits per pixel                                |
| 0x1b   | Memory model type                             |
| 0x28   | Physical address for flat memory frame buffer |

#### AX = 0x4F02 - Set VBE Mode
- Parameters
	- BX = Desired mode to set
	- ES:DI = Pointer to CRTCInfoBlock
- Return values
	- AX = VBE return status



## Links
- [VGA Hardware - OSDev Wiki](https://wiki.osdev.org/VGA_Hardware)
- [VESA BIOS Extensions - Wikipedia](https://en.wikipedia.org/wiki/VESA_BIOS_Extensions)
- [VESA Video Modes - OSDev Wiki](https://wiki.osdev.org/VESA_Video_Modes)
- [VESA BIOS EXTENSION (VBE)](https://pdos.csail.mit.edu/6.828/2018/readings/hardware/vbe3.pdf)